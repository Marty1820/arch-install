# Set the time zone
echo "Setting timezone."
ln -sf /usr/share/zoneinfo/America/Chicago /etc/localtime
hwclock --systohc

sleep 2

# Localization
echo "Setting localization"
echo en_US.UTF-8 UTF-8 >> /etc/locale.gen
echo LANG=en_US.UTF-8 >> /etc/locale.conf
locale-gen

sleep 2

# Hostname/Network configuration
echo "Configuring hostname/network"
read -p "Type Hostname > " HOSTNAME
echo $HOSTNAME >> /etc/hostname

echo "# <ip-address>    <hostname.domain.org>   <hostname>"
echo "127.0.0.1         localhost >> /etc/hosts"
echo "::1		        localhost >> /etc/hosts"
echo "127.0.1.1	        $HOSTNAME.localdomain	$HOSTNAME >> /etc/hosts"

sleep 2

# Creating a new initramfs
echo "Creating a new initramfs."
mkinitcpio -P

sleep 2

# Setting root password
read -p "Type root passwd > " rootpwd
echo -e "$rootpwd\n$rootpwd" | passwd

sleep 2

# Creating a user
while true; do
	echo "
Please Select:
1. Create a user
0. Quit
"
	read -p "Enter selection [0-1] > "

	case "$REPLY" in
	0)	echo "Continue installation."
		break
		;;
	1)	echo "User creation"
		read -p "Type user name > " username
		read -p "Type user passwd > " userpwd
		useradd -m -G wheel $username
		echo -e "$userpwd\n$userpwd" | passwd $username
		# USE SED TO REPLACE LINE
		echo -e "%wheel ALL=(ALL) ALL" >> /etc/sudoers
		sleep 2
		;;
	*)	echo "Invalid entry" >&2
		continue
		;;
	esac
done
sed -i 's/^# %wheel ALL=(ALL) ALL/%wheel ALL=(ALL) ALL/' /etc/sudoers

## PACMAN SETUP
sed -i 's/#Color/Color\\\nILoveCandy/' etc/pacman.conf
sed -i 's/#ParallelDownloads/ParallelDownloads/' etc/pacman.conf
sed -i 's/#CheckSpace/CheckSpace/' etc/pacman.conf

##############
## PACKAGES ##
##############
# Essential
pacman --needed -Sy git grub grub-btrfs efibootmgr pacman-contrib acpi bluez bluez-utils blueman intel-media-driver man-db man-pages texinfo alsa-utils reflector xdg-user-dirs

# Security/Power
pacman --needed -S fwupd fail2ban ufw tlp

# Connections
pacman --needed -S systemd-resolvconf nm-connection-editor wireguard-tools kdeconnect libfprint fprintd notification-daemon

# Extractors/Helpful
pacman --needed -S tar libarchive binutils bzip2 gzip lzop xz zstd p7zip unrar zip unzip xarchiver curl tree exa wget

#Desktop
pacman --needed -S xorg-server lightdm lightdm-slick-greeter light-locker qtile python-psutil feh imagemagick xorg-xbacklight lxappearance qt5ct conky rofi alacritty

# Visual Applications
pacman --needed -S pcmanfm gvfs gvfs-smb cifs-utils calibre cheese discord gimp deluge-gtk parted gparted bitwarden gedit gedit-plugins libreoffice-still virtualbox

# Fonts/extras
pacman --needed -S gnu-free-fonts ttf-hack youtube-dl scrot vlc btop redshift

##############
##BOOTLOADER##
##############
grub-install --target=x86_64-efi --efi-directory=/boot/efi --bootloader-id=GRUB

#######WORK IN PROGRESS################

## Get resume offset for BTRFS swapfile
cd /root/
curl -LJO https://raw.githubusercontent.com/osandov/osandov-linux/master/scripts/btrfs_map_physical.c
gcc -O2 -o btrfs_map_physical btrfs_map_physical.c
rm btrfs_map_physical.c
OFFSET=$(./btrfs_map_physical /swap/swapfile | awk 'FNR == 3 {print $1}')
PAGESIZE=$(getconf PAGESIZE)
((RESUME_OFFSET=$OFFSET/$PAGESIZE))

UUID=$(sudo blkid | grep p2 | awk '{print $2}' | tr -d '"')

#https://wiki.archlinux.org/title/Power_management/Suspend_and_hibernate#Hibernation_into_swap_file_on_Btrfs
#GRUB_TIMEOUT=2
#GRUB_CMDLINE_LINUX_DEFAULT="loglevel=3 quiet mem_sleep_default=deep resume=$UUID resume_offset=$RESUME_OFFSET"
#GRUB_CMDLINE_LINUX="net.ifnames=0"
#GRUB_TIMEOUT_STYLE=hidden
#GRUB_DISABLE_SUBMENU=y

######################################

grub-mkconfig -o /boot/grub/grub.cfg

sleep 2

##############
##APP SETUP ##
##############
# Notifications Setup
touch /usr/share/dbus-1/services/org.freedesktop.Notifications.service
tee /usr/share/dbus-1/services/org.freedesktop.Notifications.service > /dev/null <<EOT
[D-BUS Service]
Name=org.freedesktop.Notifications
Exec=/usr/lib/notification-daemon-1.0/notification-daemon
EOT

# Lightdm greeter change
sed -i 's/#greeter-session=example-gtk-gnome/greeter-session=lightdm-slick-greeter/' /etc/lightdm/lightdm.conf
# Slick greeter settings
tee -a /etc/lightdm/slick-greeter.conf > /dev/null <<EOT
background-color = #282a36
show-hostname = true
show-power = true
show-a11y = false
show-keyboard = false
show-clock = true
show-quit = true
font-name = Hack
onscreen-keyboard = false
enable-hidpi = on
clock-format = %b %d %I:%M%p

# FAIL2BAN Setup
cp /etc/fail2ban/jail.conf /etc/fail2ban/jail.local
touch /var/log/auth.log
tee -a /etc/fail2ban/jail.local > /dev/null <<EOT
[ssh]
enabled = true
port = ssh
filter = sshd
logpath = /var/log/auth.log
maxretry = 6
EOT

# UFW Defaults
ufw default deny incoming
ufw default allow outgoing
#must be enable after reboot
#ufw enable

#HAVEN'T TESTED TRACKPAD
# Proper trackpad clicking
#touch /etc/X11/xorg.conf.d/30-touchpad.conf
#tee -a /etc/X11/xorg.conf.d/30-touchpad.conf > /dev/null <<EOT
#Section "InputClass"
#    Identifier "PIXA3854:00 093A:0274 Touchpad"
#    Driver "libinput"
#    Option "Tapping" "on"
#    Option "ClickMethod" "clickfinger"
#EndSection
#EOT

##############
##AUR HELPER##
##############
# PARU Setup
##ERROR: can't due as root!?
pacman -S --needed base-devel
git clone https://aur.archlinux.org/paru.git && cd paru
makepkg -si
cd .. && rm -dR paru
# AUR PACKAGES
paru -S minecraft-launcher nerd-fonts-complete timeshift ttf-ms-fonts visual-studio-code-bin

# Enabling services
systemctl enable NetworkManager.service
systemctl enable systemd-resolved.service
systemctl enable tlp.service
systemctl enable lightdm.service
systemctl enable fail2ban.service
systemctl enable bluetooth.service
systemctl enable cronie.service
systemctl enable fstrim.timer

# Frame.Work specific settings
# acpi issue
sed -i -i 's/#RebootWatchdogSec=0/RebootWatchdogSec=0/g' /etc/systemd/system.conf
# Stuttering and periodic freeze
echo -e "options i915 enable_psr=0" >> /etc/modprobe.d/i915.conf
# Trackpad setup
touch /etc/X11/xorg.conf.d/30-touchpad.conf
tee /etc/X11/xorg.conf.d/30-touchpad.conf > /dev/null <<EOT
Section "InputClass"
    Identifier "PIXA3854:00 093A:0274 Touchpad"
    Driver "libinput"
    Option "Tapping" "on"
    Option "ClickMethod" "clickfinger"
    Option "DisableWhileTyping" "true"
EndSection
EOT

####################
##WORK IN PROGRESS##
####################
# Add post install notes in users home
# Setup fingerprint : https://wiki.archlinux.org/title/Fprint
# touch /home/$username/recommendations.txt
# tee /home/$username/recommendations.txt > /dev/null <<EOT
#UFW is not enabled please run 'sudo ufw enable' to turn on
#EOT

exit
swapoff /mnt/swap/swapfile
umount -R /mnt
echo "We are done. Reboot your computer and remove installation media"
echo "Run part 3 in your home folder after login...coming soon"
