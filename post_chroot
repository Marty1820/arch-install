# Set the time zone
echo "Setting timezone."
ln -sf /usr/share/zoneinfo/America/Chicago /etc/localtime
hwclock --systohc

sleep 2

# Localization
echo "Setting localization"
echo en_US.UTF-8 UTF-8 >> /etc/locale.gen
echo LANG=en_US.UTF-8 >> /etc/locale.conf
locale-gen

sleep 2

# Hostname/Network configuration
echo "Configuring hostname/network"
read -p "Type Hostname > " HOSTNAME
echo $HOSTNAME >> /etc/hostname

echo 127.0.0.1	localhost >> /etc/hosts 
echo ::1		localhost >> /etc/hosts
echo 127.0.1.1	$HOSTNAME.localdomain	$HOSTNAME >> /etc/hosts

sleep 2

# Creating a new initramfs
echo "Creating a new initramfs."
mkinitcpio -P

sleep 2

# Setting root password
read -p "Type root passwd > " rootpwd
echo -e "$rootpwd\n$rootpwd" | passwd

sleep 2

# Creating a user
while true; do
	echo "
Please Select:
1. Create a user
0. Quit
"
	read -p "Enter selection [0-1] > "

	case "$REPLY" in
	0)	echo "Continue installation."
		break
		;;
	1)	echo "User creation"
		read -p "Type user name > " username
		read -p "Type user passwd > " userpwd
		useradd -m -g wheel $username
		echo -e "$userpwd\n$userpwd" | passwd $username
		# USE SED TO REPLACE LINE
		echo -e "%wheel ALL=(ALL) ALL" >> /etc/sudoers
		sleep 2
		;;
	*)	echo "Invalid entry" >&2
		continue
		;;
	esac
done
#echo -e "root ALL=(ALL:ALL) ALL" >> /etc/sudoers


# Instaling and configuring packages & bootloader
pacman --needed -Sy git fwupd fail2ban ufw curl tree exa wget reflector systemd-resolvconf tlp tar libarchive binutils bzip2 gzip lzop xz zstd p7zip unrar zip unzip man-db man-pages texinfo alsa-utils notification-daemon xorg-server lightdm lightdm-slick-greeter qtile alacritty grub grub-btrfs efibootmgr nm-connection-editor parted gparted wireguard-tools libfprint fprintd youtube-dl vivaldi vivaldi-ffmpeg-codecs bitwarden gedit gedit-plugins libreoffice-still virtualbox feh imagemagick xorg-xbacklight lxappearance qt5ct conky rofi gnu-free-fonts ttf-hack pcmanfm gvfs gvfs-smb cifs-utils xarchiver calibre cheese discord gimp deluge-gtk code scrot vlc btop pacman-contrib kdeconnect redshift acpi bluez bluez-utils blueman

grub-install --target=x86_64-efi --efi-directory=/boot/efi --bootloader-id=GRUB

# Need to edit some lines in grub/can be done afterwards too
#GRUB_CMDLINE_LINUX_DEFAULT="loglevel=3 quiet mem_sleep_default=deep resume=UUID=6be67022-0337-45df-8aab-97b51e67cf12 resume_offset=4461824"
#change GRUB_TIMEOUT_STYLE=hidden

grub-mkconfig -o /boot/grub/grub.cfg
sleep 2

# Notifications Setup
touch /usr/share/dbus-1/services/org.freedesktop.Notifications.service
tee /usr/share/dbus-1/services/org.freedesktop.Notifications.service > /dev/null <<EOT
[D-BUS Service]
Name=org.freedesktop.Notifications
Exec=/usr/lib/notification-daemon-1.0/notification-daemon
EOT

# FAIL2BAN Setup
cp /etc/fail2ban/jail.conf /etc/fail2ban/jail.local
touch /var/log/auth.log
tee -a /etc/fail2ban/jail.local > /dev/null <<EOT
[ssh]
enabled = true
port = ssh
filter = sshd
logpath = /var/log/auth.log
maxretry = 6
EOT

# UFW Defaults
ufw default deny incoming
ufw default allow outgoing
#must be enable after reboot
#ufw enable

#HAVEN'T TESTED TRACKPAD
# Proper trackpad clicking
touch /etc/X11/xorg.conf.d/30-touchpad.conf
tee -a /etc/X11/xorg.conf.d/30-touchpad.conf > /dev/null <<EOT
Section "InputClass"
    Identifier "PIXA3854:00 093A:0274 Touchpad"
    Driver "libinput"
    Option "Tapping" "on"
    Option "ClickMethod" "clickfinger"
EndSection
EOT

# PARU Setup
sudo pacman -S --needed base-devel
git clone https://aur.archlinux.org/paru.git
cd paru
makepkg -si
paru -S minecraft-launcher nerd-fonts-complete timeshift ttf-ms-fonts

# More Services

# Finishing
systemctl enable NetworkManager.service
systemctl enable systemd-resolved.service
systemctl enable tlp.service
systemctl enable lightdm.service
systemctl enable fail2ban.service
systemctl enable bluetooth.service
systemctl enable cronie.service

exit
swapoff /mnt/swap/swapfile
umount -R /mnt
echo "We are done. Reboot your computer and remove installation media"
echo "Run part 3 in your home folder after login...coming soon"
